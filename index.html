<html lang="en">
  <head>
    <title>Motion Instrument</title>
    <meta charset="UTF-8" />
  </head>

  <body>
    <div id="app"></div>
    <h1>Basic motion instrument demo</h1>
    <button class="mute" data-muted="false">Mute</button>
    <!-- <audio id = "mp32" crossOrigin = "anonymous" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/858/outfoxing.mp3" autoplay></audio> -->
    <!-- <audio id = "mp31" crossOrigin = "anonymous" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/858/outfoxing.mp3" autoplay></audio> -->
    <!-- <script src="src/footdrum_web_worker.cjs"></script> -->
    <!-- <script src="src/instrument.cjs"></script> -->
    <script>
      const ws = new WebSocket("ws://localhost:8080");

      ws.addEventListener("open", () => {
        console.log("web client: handshake! We are connected");
      });

      let isAppInit = false;
      var sinea = null;
      var sineb = null;
      var sinec = null;
      var volume = null;
      var delay;
      var delayFeedback;
      var audioCtx;
      var x_val = 0;
      var y_val = 0;

      window.addEventListener("click", init);

      function init() {
        if (isAppInit) {
          return;
        }

        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        delay = audioCtx.createDelay(5);
        delay.delayTime.value = 0.09;
        delayFeedback = audioCtx.createGain();
        delayFeedback.gain.value = 0.79;

        volume = audioCtx.createGain();

        sinea = audioCtx.createOscillator();
        sinea.frequency.value = 440;
        sinea.type = "sine";
        sinea.start();
        sinea.connect(volume);

        sineb = audioCtx.createOscillator();
        sineb.frequency.value = 523.25;
        sineb.type = "sine";
        sineb.start();
        sineb.connect(volume);

        sinec = audioCtx.createOscillator();
        sinec.frequency.value = 698.46;
        sinec.type = "sine";
        sinec.start();
        sinec.connect(volume);

        volume.connect(delay);
        volume.connect(audioCtx.destination);
        delayFeedback.connect(volume);
        delay.connect(delayFeedback);
        delayFeedback.connect(delay);

        volume.gain.value = 0.2;
        console.log("got here!");

        isAppInit = true;
      }

      const mute = document.querySelector(".mute");

      mute.onclick = function () {
        if (mute.getAttribute("data-muted") === "false") {
          volume.disconnect(audioCtx.destination);
          mute.setAttribute("data-muted", "true");
          mute.innerHTML = "Unmute";
        } else {
          volume.connect(audioCtx.destination);
          mute.setAttribute("data-muted", "false");
          mute.innerHTML = "Mute";
        }
      };

      ws.addEventListener("message", function (e) {
        const msg = e.data;
        console.log(e.data);
        const nums_str = msg.split('\t');
        x_val = parseFloat(nums_str[0]);
        y_val = parseFloat(nums_str[1]);
        sinea.frequency.value = (x_val / 1000.0) * 440 + 400;
        sineb.frequency.value = (x_val / 1000.0) * 523.25  + 400;
        sinec.frequency.value = (x_val / 1000.0) * 698.46 + 400;
        delayFeedback.gain.value = Math.max(0.7, y_val / 700.0);
      });
    </script>
  </body>
</html>
