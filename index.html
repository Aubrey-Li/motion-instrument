<html lang="en">
  <head>
    <title>Motion Instrument</title>
    <meta charset="UTF-8" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1Â " />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.11.2/css/all.css"
    />
    <!-- Google Fonts AudioWide-->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap"
      rel="stylesheet"
    />
    <!-- MDB -->
    <link rel="stylesheet" href="css/mdb.min.css" />
    <!-- Custom styles -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="./app.css" />
  </head>

  <body>
    <div class="video-wrapper">
      <video playsinline autoplay muted loop>
        <source
          class="h-100"
          src="https://mdbootstrap.com/img/video/Lines.mp4"
          type="video/mp4"
        />
      </video>

      <div class="header">
        <h1>M Shock</h1>
        <p style="font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif">Revolutionize the way you make music</p>
        <button class="mute" data-muted="false">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span>Mute</span>
        </button>
        <button class="button">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span>Electronic</span>
        </button>
        <button class="violin">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span>Synthesized</span>
        </button>
      </div>
    </div>
    <!-- <button class="mute" data-muted="false">Mute</button>
    <button class="violin">Violin</button> -->
    <script>
      const ws = new WebSocket("ws://localhost:8080");

      ws.addEventListener("open", () => {
        console.log("web client: handshake! We are connected");
      });

      let isAppInit = false;
      var sinea = null;
      var sineb = null;
      var sinec = null;
      var volume = null;
      var delay;
      var delayFeedback;
      var audioCtx;
      var x_val = 0;
      var y_val = 0;

      window.addEventListener("click", init);

      function init() {
        if (isAppInit) {
          return;
        }

        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        delay = audioCtx.createDelay(5);
        delay.delayTime.value = 0.09;
        delayFeedback = audioCtx.createGain();
        delayFeedback.gain.value = 0.79;

        volume = audioCtx.createGain();

        sinea = audioCtx.createOscillator();
        sinea.frequency.value = 440;
        sinea.type = "sine";
        sinea.start();
        sinea.connect(volume);

        sineb = audioCtx.createOscillator();
        sineb.frequency.value = 523.25;
        sineb.type = "sine";
        sineb.start();
        sineb.connect(volume);

        sinec = audioCtx.createOscillator();
        sinec.frequency.value = 698.46;
        sinec.type = "sine";
        sinec.start();
        sinec.connect(volume);

        volume.connect(delay);
        volume.connect(audioCtx.destination);
        delayFeedback.connect(volume);
        delay.connect(delayFeedback);
        delayFeedback.connect(delay);

        volume.gain.value = 0.2;
        console.log("got here!");

        isAppInit = true;
      }

      const mute = document.querySelector(".mute");

      mute.onclick = function () {
        if (mute.getAttribute("data-muted") === "false") {
          volume.disconnect(audioCtx.destination);
          mute.setAttribute("data-muted", "true");
        } else {
          volume.connect(audioCtx.destination);
          mute.setAttribute("data-muted", "false");
        }
      };

      const violin = document.querySelector("./violin");
      violin.onlick = function () {
        someglobalvar = 1;
      };

      ws.addEventListener("message", function (e) {
        const msg = e.data;
        console.log(e.data);
        const nums_str = msg.split("\t");
        x_val = parseFloat(nums_str[0]);
        y_val = parseFloat(nums_str[1]);
        sinea.frequency.value = (x_val / 1000.0) * 440 + 400;
        sineb.frequency.value = (x_val / 1000.0) * 523.25 + 400;
        sinec.frequency.value = (x_val / 1000.0) * 698.46 + 400;
        delayFeedback.gain.value = Math.max(0.7, y_val / 700.0);
      });

      // button.addEventListener('click', playDrum(x_val, y_val));
    </script>
  </body>
</html>
