<html lang="en">
  <head>
    <title>Motion Instrument</title>
    <meta charset="UTF-8" />
  </head>

  <body>
    <div id="app"></div>
    <h1>Basic motion instrument demo</h1>
    <button class="mute" data-muted="false">Mute</button>
    <button class="violin">Violin</button>
    <button class="drums">Drums</button>
    <audio id = "mp32" crossOrigin = "anonymous" src="drum.mp3" autoplay></audio> 
    <audio id = "mp31" crossOrigin = "anonymous" src="cymbal.mp3" autoplay></audio> 
    <script>
      const ws = new WebSocket("ws://localhost:8080");
      ws.addEventListener("open", () => {
        console.log("web client: handshake! We are connected");
      });
      //---init  for violin
      let isAppInit = false;
      var sinea = null;
      var sineb = null;
      var sinec = null;
      var volume = null;
      var delay;
      var delayFeedback;
      var audioCtx;
      var x_val = 0;
      var y_val = 0;
      var inst = 0
      var count = 0
      const instruments = ["sine", "square", "sawtooth", "triangle"]
      const notes = [261.63, 293.66, 329.63, 349.23, 392, 440, 493.88]
      window.addEventListener("click", init);
      //window.addEventListener("click", drumHandler);
      const ii = document.querySelector(".violin");
      const jj = document.querySelector(".drums");
      instrument_type = 0;
//       //----init for drum
//       // Importing the required modules

// // const playButton = document.querySelector('button');
// // console.log("playbutton", playButton);
//       var drumstate = 0;
//       var initilaize = 1;
//       var audioContext = null;
//       var drumElement = null;
//       var drumTrack = null;
//       var snareTrack = null;
//       var AudioCC = null;
//       var activated = 0;
// playButton.addEventListener('click', drumHandler);
      ii.onclick = function() {
        volume.gain.value = 0.2;
        instrument_type = 0;
      }
      jj.onclick = function()  {
        volume.gain.value = 0;
        
        instrument_type = 1;
      }
      // function drumHandler() {
      //   if (initilaize == 0) {
      //     console.log('1');
      //     //initilaize += 1;
      //     console.log('12');
      //     AudioCC = window.AudioContext || window.webkitAudioContext;
      //     console.log('123');
      //     audioContext = new AudioCC();
      //     console.log('11');
      //     drumElement = document.querySelector('#mp31')
      //     console.log('12');
      //     drumTrack = audioContext.createMediaElementSource(drumElement);
      //     snareElement = document.querySelector('#mp32')
      //     snareTrack = audioContext.createMediaElementSource(snareElement);
      //     console.log('2');
      //     if (audioContext.state === 'suspended') { //autoplay policy
      //       audioContext.resume();
      //     }
      //     drumTrack.connect(audioContext.destination);
      //     snareTrack.connect(audioContext.destination);
      //     console.log("initialization complete!")
      //   }
      // }

      function init() {
        if (isAppInit) {
          return;
        }

        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // delay = audioCtx.createDelay(5);
        // delay.delayTime.value = 0.09;
        // delayFeedback = audioCtx.createGain();
        // delayFeedback.gain.value = 0.79;

        volume = audioCtx.createGain();

        sinea = audioCtx.createOscillator();
        sinea.frequency.value = 440;
        sinea.type = "sawtooth";
        sinea.start();
        sinea.connect(volume);

        // sineb = audioCtx.createOscillator();
        // sineb.frequency.value = 523.25;
        // sineb.type = "sine";
        // sineb.start();
        // sineb.connect(volume);

        // sinec = audioCtx.createOscillator();
        // sinec.frequency.value = 698.46;
        // sinec.type = "sine";
        // sinec.start();
        // sinec.connect(volume);

        //volume.connect(delay);
        volume.connect(audioCtx.destination);
        // delayFeedback.connect(volume);
        // delay.connect(delayFeedback);
        // delayFeedback.connect(delay);

        volume.gain.value = 0.2;
        console.log("got here!");

        isAppInit = true;
      }

      const mute = document.querySelector(".mute");
      
      mute.onclick = function () {
        if (mute.getAttribute("data-muted") === "false") {
          volume.disconnect(audioCtx.destination);
          mute.setAttribute("data-muted", "true");
          mute.innerHTML = "Unmute";
        } else {
          volume.connect(audioCtx.destination);
          mute.setAttribute("data-muted", "false");
          mute.innerHTML = "Mute";
        }
      };

      ws.addEventListener("message", function (e) {
        const msg = e.data;
        count += 1;
        //console.log(e.data);
        const nums_str = msg.split('\t');
        x_val = parseFloat(nums_str[0]);
        y_val = parseFloat(nums_str[1]);
        angle_y = y_val;
        z_accel = parseFloat(nums_str[4])
        if (instrument_type == 0) {
          
          sinea.frequency.value = notes[Math.floor(x_val/40) % 7 ];
          volume.gain.value = y_val/360;
          if (z_accel > 2 && count % 10 == 0) {
            inst += 1;
            sinea.type = instruments[inst % 4];
            console.log(instruments[inst % 4]);
          }
        } else {
          console.log(angle_y);
          if (angle_y > 250) { // TO-DO: check value based on band design
            console.log("b");
            activated = 1;
          } else if (angle_y < 110) {
            console.log("c");
            activated = 2;
          } else { //autoplay policy
            console.log("d");
        
            // if (audioContext.state === 'suspended') {
            //   audioContext.resume();
            // }
            if (activated == 1) {
              console.log('hear the drum!');
              test = new Audio("drum.mp3");
              test.play();
              //drumElement.play();
              activated = 0;
            

            } else if (activated == 2) {
              console.log('hear the kick');
              console.log(`[From Main]: hello`);
              test = new Audio("drum.mp3");
              test.play();
              //snareElement.play()
              activated = 0;
            

            } else {
              console.log("activated is 0");
            }

          }
        }

        


        //sineb.frequency.value = (x_val / 1000.0) * 523.25  + 400;
        //sinec.frequency.value = (x_val / 1000.0) * 698.46 + 400;
        //delayFeedback.gain.value = Math.max(0.7, y_val / 700.0);
      });
    </script>
  </body>
</html>
